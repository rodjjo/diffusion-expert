###########
PyObject_CallMethod( modStringIO, ( char* ) "StringIO", NULL );
PyErr_NormalizeException( &type, &value, &traceback );

###########
PyObject * main_module = PyImport_ImportModule("__main__");
PyObject* global_symbol_table = PyModule_GetDict(main_module);
PyObject* local_symbol_table = PyDict_New();
PyObject* python_file_obj = PyFile_FromString("script.py", "r");
FILE*  to_run_script = PyFile_AsFile(python_file_obj);
if (to_run_script != NULL)
    PyRun_File(to_run_script, "script.py", Py_file_input, global_symbol_table, local_symbol_table);

##########

if(PyErr_Occurred() != NULL) {
    PyObject *pyExcType;
    PyObject *pyExcValue;
    PyObject *pyExcTraceback;
    PyErr_Fetch(&pyExcType, &pyExcValue, &pyExcTraceback);
    PyErr_NormalizeException(&pyExcType, &pyExcValue, &pyExcTraceback);

    PyObject* str_exc_type = PyObject_Repr(pyExcType);
    PyObject* pyStr = PyUnicode_AsEncodedString(str_exc_type, "utf-8", "Error ~");
    const char *strExcType =  PyBytes_AS_STRING(pyStr);

    PyObject* str_exc_value = PyObject_Repr(pyExcValue);
    PyObject* pyExcValueStr = PyUnicode_AsEncodedString(str_exc_value, "utf-8", "Error ~");
    const char *strExcValue =  PyBytes_AS_STRING(pyExcValueStr);

    // When using PyErr_Restore() there is no need to use Py_XDECREF for these 3 pointers
    //PyErr_Restore(pyExcType, pyExcValue, pyExcTraceback);

    Py_XDECREF(pyExcType);
    Py_XDECREF(pyExcValue);
    Py_XDECREF(pyExcTraceback);

    Py_XDECREF(str_exc_type);
    Py_XDECREF(pyStr);

    Py_XDECREF(str_exc_value);
    Py_XDECREF(pyExcValueStr);
}

#### 

intptr_t h = (intptr_t) (src_type == log_source_stdout ? STD_OUTPUT_HANDLE : STD_ERROR_HANDLE);
int fd = _open_osfhandle((h), O_TEXT);
// SetStdHandle(h, (HANDLE) _get_osfhandle(pipefd[1]));

## see
https://github.com/ratwithacompiler/diffusers_stablediff_conversion/blob/main/convert_original_stable_diffusion_to_diffusers.py